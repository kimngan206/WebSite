<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Qu·∫£n l√Ω li√™n h·ªá</title>
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="manage_contact.css">

</head>

<body>
    <div class="table-wrapper">
        <h1>üìû Qu·∫£n l√Ω li√™n h·ªá</h1>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>H·ªç v√† t√™n</th>
                    <th>Email</th>
                    <th>SƒêT</th>
                    <th>Lo·∫°i y√™u c·∫ßu</th>
                    <th>Lo·∫°i xe</th>
                    <th>Kho·∫£ng Ti·ªÅn</th>
                    <th>Tin nh·∫Øn chi ti·∫øt</th>
                    <th>Ng√†y t·∫°o</th>
                    <th>Thao t√°c</th>
                </tr>
            </thead>
            <tbody id="contactTableBody"></tbody>
        </table>
    </div>

    <!-- Confirmation Modal (cho vi·ªác x√≥a) -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <h3>X√°c nh·∫≠n x√≥a li√™n h·ªá</h3>
            <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a li√™n h·ªá n√†y kh√¥ng?</p>
            <div class="modal-buttons">
                <button class="confirm-btn" id="confirmDeleteBtn">X√≥a</button>
                <button class="cancel-btn" id="cancelDeleteBtn">H·ªßy</button>
            </div>
        </div>
    </div>

    <!-- Global Feedback Message -->
    <div id="globalFeedback" class="global-feedback"></div>

    <script>
        // Modal elements (for delete confirmation)
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtnForConfirmation = document.getElementById('cancelDeleteBtn');
        let contactIdToDelete = null; // Variable to store the ID of the contact to be deleted

        const contactTableBody = document.getElementById('contactTableBody');

        // Feedback element
        const globalFeedback = document.getElementById('globalFeedback');

        // Base API URL cho API li√™n h·ªá
        const API_URL = 'https://backend-xolq.onrender.com/api/contacts';

        // --- Global Feedback Functions ---
        function showGlobalFeedback(message, isSuccess) {
            globalFeedback.textContent = message;
            globalFeedback.className = 'global-feedback'; // Reset classes
            if (isSuccess) {
                globalFeedback.classList.add('success');
            } else {
                globalFeedback.classList.add('error');
            }
            globalFeedback.style.display = 'block';
            globalFeedback.style.opacity = 1;

            setTimeout(() => {
                globalFeedback.style.opacity = 0;
                setTimeout(() => {
                    globalFeedback.style.display = 'none';
                }, 500); // Wait for fade out to complete
            }, 3000); // Show for 3 seconds
        }

        // --- Confirmation Modal Functions ---
        function showConfirmationModal(contactId) {
            contactIdToDelete = contactId;
            confirmationModal.style.display = 'flex'; // Use flex to center the modal content
        }

        function hideConfirmationModal() {
            contactIdToDelete = null;
            confirmationModal.style.display = 'none';
        }

        cancelDeleteBtnForConfirmation.addEventListener('click', hideConfirmationModal);

        confirmDeleteBtn.addEventListener('click', () => {
            if (contactIdToDelete) {
                deleteContact(contactIdToDelete);
            }
        });

        // --- CRUD Operations for Contacts ---

        // Load Contacts
        async function loadContacts() {
            try {
                const res = await fetch(API_URL);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const contacts = await res.json();
                contactTableBody.innerHTML = ''; // Clear existing rows

                if (contacts.length === 0) {
                    contactTableBody.innerHTML = '<tr><td colspan="10" style="text-align:center;">Kh√¥ng c√≥ d·ªØ li·ªáu li√™n h·ªá n√†o.</td></tr>';
                    return;
                }

                contacts.forEach(c => {
                    const tr = document.createElement('tr');
                    // ƒê·ªãnh d·∫°ng ng√†y gi·ªù n·∫øu c√≥
                    const createdAt = c.created_at ? new Date(c.created_at).toLocaleString('vi-VN') : 'N/A';
                    tr.innerHTML = `
                        <td>${c.id}</td>
                        <td>${c.full_name}</td>
                        <td>${c.email}</td>
                        <td>${c.phone_number}</td>
                        <td>${c.request_type || 'N/A'}</td>
                        <td>${c.car_type || 'N/A'}</td>
                        <td>${c.budget || 'N/A'}</td>
                        <td class="contact-message-cell">${c.detailed_message || 'N/A'}</td>
                        <td>${createdAt}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-delete" onclick="showConfirmationModal(${c.id})">X√≥a</button>
                            </div>
                        </td>
                    `;
                    contactTableBody.appendChild(tr);
                });
            } catch (err) {
                console.error('L·ªói khi t·∫£i d·ªØ li·ªáu li√™n h·ªá:', err);
                contactTableBody.innerHTML = '<tr><td colspan="10" style="text-align:center; color:red;">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu li√™n h·ªá. Vui l√≤ng th·ª≠ l·∫°i sau.</td></tr>';
                showGlobalFeedback('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu li√™n h·ªá. Vui l√≤ng th·ª≠ l·∫°i sau.', false);
            }
        }

        // Delete Contact
        async function deleteContact(contactId) {
            hideConfirmationModal(); // Hide modal immediately after confirmation

            try {
                const res = await fetch(`${API_URL}/${contactId}`, {
                    method: 'DELETE',
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'Kh√¥ng th·ªÉ x√≥a li√™n h·ªá.');
                }

                showGlobalFeedback(`Li√™n h·ªá v·ªõi ID ${contactId} ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng.`, true);
                loadContacts(); // Reload the table to reflect the changes
            } catch (err) {
                console.error('L·ªói khi x√≥a li√™n h·ªá:', err);
                showGlobalFeedback(err.message || 'Kh√¥ng th·ªÉ x√≥a li√™n h·ªá.', false);
            }
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', loadContacts);
    </script>
</body>

</html>