<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Qu·∫£n l√Ω s·∫£n ph·∫©m</title>
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="product_manage.css">
</head>

<body>
    <div class="table-wrapper">
        <h1>üì¶ Qu·∫£n l√Ω s·∫£n ph·∫©m</h1>

        <!-- N√∫t ƒë·ªÉ m·ªü form th√™m s·∫£n ph·∫©m -->
        <button class="btn btn-open-add-form" id="showAddProductFormBtn">Th√™m s·∫£n ph·∫©m m·ªõi</button>

        <!-- Form ƒë·ªÉ th√™m/s·ª≠a s·∫£n ph·∫©m (s·∫Ω ho·∫°t ƒë·ªông nh∆∞ m·ªôt alert/modal) -->
        <div class="add-product-form" id="addProductFormModal">
            <h2 id="formTitle">Th√™m s·∫£n ph·∫©m m·ªõi</h2>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group">
                    <label for="productName">T√™n s·∫£n ph·∫©m:</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label for="productPrice">Gi√°:</label>
                    <input type="number" id="productPrice" min="0" required>
                </div>
                <div class="form-group">
                    <label for="productDescription">M√¥ t·∫£:</label>
                    <textarea id="productDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="productImage">URL h√¨nh ·∫£nh:</label>
                    <input type="url" id="productImage" placeholder="https://example.com/image.jpg" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-add" id="submitProductBtn">Th√™m s·∫£n ph·∫©m</button>
                    <button type="button" class="btn btn-cancel-edit" id="cancelEditBtn">H·ªßy</button>
                </div>
            </form>
        </div>

        <!-- Overlay cho form th√™m/s·ª≠a s·∫£n ph·∫©m -->
        <div class="form-overlay" id="formOverlay"></div>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>H√¨nh ·∫£nh</th>
                    <th>T√™n s·∫£n ph·∫©m</th>
                    <th>Gi√°</th>
                    <th>M√¥ t·∫£</th>
                    <th>Thao t√°c</th>
                </tr>
            </thead>
            <tbody id="productTableBody"></tbody>
        </table>
    </div>

    <!-- Confirmation Modal (cho vi·ªác x√≥a) -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <h3>X√°c nh·∫≠n x√≥a s·∫£n ph·∫©m</h3>
            <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh√¥ng?</p>
            <div class="modal-buttons">
                <button class="confirm-btn" id="confirmDeleteBtn">X√≥a</button>
                <button class="cancel-btn" id="cancelDeleteBtn">H·ªßy</button>
            </div>
        </div>
    </div>

    <!-- Global Feedback Message -->
    <div id="globalFeedback" class="global-feedback"></div>


    <script>
        // Modal elements (for delete confirmation)
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtnForConfirmation = document.getElementById('cancelDeleteBtn'); // ƒê·ªïi t√™n ƒë·ªÉ tr√°nh tr√πng l·∫∑p ID
        let productIdToDelete = null; // Variable to store the ID of the product to be deleted

        // Form elements (for add/edit product)
        const addProductFormModal = document.getElementById('addProductFormModal'); // Form modal itself
        const formOverlay = document.getElementById('formOverlay'); // Overlay element
        const showAddProductFormBtn = document.getElementById('showAddProductFormBtn'); // Button to open the form modal

        const productForm = document.getElementById('productForm');
        const productIdInput = document.getElementById('productId');
        const productNameInput = document.getElementById('productName');
        const productPriceInput = document.getElementById('productPrice');
        const productDescriptionInput = document.getElementById('productDescription');
        const productImageInput = document.getElementById('productImage');
        const submitProductBtn = document.getElementById('submitProductBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn'); // N√∫t H·ªßy trong form th√™m/s·ª≠a
        const formTitle = document.getElementById('formTitle');
        const productTableBody = document.getElementById('productTableBody');

        // Feedback element
        const globalFeedback = document.getElementById('globalFeedback');

        // Base API URL (replace with your actual product API endpoint)
        const API_URL = 'https://backend-xolq.onrender.com/api/manage_product'; // Assuming products endpoint

        // --- Global Feedback Functions ---
        function showGlobalFeedback(message, isSuccess) {
            globalFeedback.textContent = message;
            globalFeedback.className = 'global-feedback'; // Reset classes
            if (isSuccess) {
                globalFeedback.classList.add('success');
            } else {
                globalFeedback.classList.add('error');
            }
            globalFeedback.style.display = 'block';
            globalFeedback.style.opacity = 1;

            setTimeout(() => {
                globalFeedback.style.opacity = 0;
                setTimeout(() => {
                    globalFeedback.style.display = 'none';
                }, 500); // Wait for fade out to complete
            }, 3000); // Show for 3 seconds
        }

        // --- Form Modal (Alert) Functions ---
        function showProductFormModal() {
            addProductFormModal.style.display = 'block'; // Hi·ªÉn th·ªã form
            formOverlay.style.display = 'block'; // Hi·ªÉn th·ªã overlay
            productForm.reset(); // X√≥a form khi m·ªü
            productIdInput.value = '';
            formTitle.textContent = 'Th√™m s·∫£n ph·∫©m m·ªõi';
            submitProductBtn.textContent = 'Th√™m s·∫£n ph·∫©m';
            submitProductBtn.classList.replace('btn-update', 'btn-add');
            cancelEditBtn.style.display = 'inline-block'; // ƒê·∫£m b·∫£o n√∫t h·ªßy lu√¥n hi·ªán khi form ƒë∆∞·ª£c m·ªü
        }

        function hideProductFormModal() {
            addProductFormModal.style.display = 'none'; // ·∫®n form
            formOverlay.style.display = 'none'; // ·∫®n overlay
            productForm.reset(); // X√≥a form
            productIdInput.value = '';
            formTitle.textContent = 'Th√™m s·∫£n ph·∫©m m·ªõi';
            submitProductBtn.textContent = 'Th√™m s·∫£n ph·∫©m';
            submitProductBtn.classList.replace('btn-update', 'btn-add');
        }

        // Event listener for the new "Th√™m s·∫£n ph·∫©m m·ªõi" button
        showAddProductFormBtn.addEventListener('click', showProductFormModal);

        // Event listener for the "H·ªßy" button inside the form modal
        cancelEditBtn.addEventListener('click', hideProductFormModal);

        // Event listener for overlay click to close form modal
        formOverlay.addEventListener('click', hideProductFormModal);


        // --- Confirmation Modal (for delete) Functions ---
        function showConfirmationModal(productId) {
            productIdToDelete = productId;
            confirmationModal.style.display = 'flex'; // Use flex to center the modal content
        }

        function hideConfirmationModal() {
            productIdToDelete = null;
            confirmationModal.style.display = 'none';
        }

        cancelDeleteBtnForConfirmation.addEventListener('click', hideConfirmationModal); // S·ª≠ d·ª•ng t√™n m·ªõi
        confirmDeleteBtn.addEventListener('click', () => {
            if (productIdToDelete) {
                deleteProduct(productIdToDelete);
            }
        });

        // --- CRUD Operations ---

        // Load Products
        async function loadProducts() {
            try {
                const res = await fetch(API_URL);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const products = await res.json();
                productTableBody.innerHTML = ''; // Clear existing rows
                products.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${p.id}</td>
                        <td><img src="${p.image}" alt="${p.name}" class="product-image" onerror="this.onerror=null;this.src='https://placehold.co/80x80/cccccc/000000?text=No+Image';"></td>
                        <td>${p.name}</td>
                        <td>${p.price.toLocaleString('vi-VN')} VNƒê</td>
                        <td>${p.description || 'N/A'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-edit" onclick="editProduct(${p.id})">S·ª≠a</button>
                                <button class="btn btn-delete" onclick="showConfirmationModal(${p.id})">X√≥a</button>
                            </div>
                        </td>
                    `;
                    productTableBody.appendChild(tr);
                });
            } catch (err) {
                console.error('L·ªói khi t·∫£i d·ªØ li·ªáu s·∫£n ph·∫©m:', err);
                productTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i sau.</td></tr>';
                showGlobalFeedback('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i sau.', false);
            }
        }

        // Add/Update Product
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const productData = {
                name: productNameInput.value,
                price: parseFloat(productPriceInput.value),
                description: productDescriptionInput.value,
                image: productImageInput.value
            };

            const productId = productIdInput.value;
            let successMessage = '';
            let errorMessage = '';

            try {
                let res;
                if (productId) {
                    // Update existing product
                    res = await fetch(`${API_URL}/${productId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(productData),
                    });
                    successMessage = 'S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!';
                    errorMessage = 'L·ªói khi c·∫≠p nh·∫≠t s·∫£n ph·∫©m.';
                } else {
                    // Add new product
                    res = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(productData),
                    });
                    successMessage = 'S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng!';
                    errorMessage = 'L·ªói khi th√™m s·∫£n ph·∫©m.';
                }

                if (!res.ok) {
                    const errorDetails = await res.json();
                    throw new Error(errorDetails.message || errorMessage);
                }

                showGlobalFeedback(successMessage, true);
                hideProductFormModal(); // ·∫®n form sau khi th√™m/s·ª≠a th√†nh c√¥ng
                loadProducts(); // Reload products table

            } catch (err) {
                console.error('L·ªói khi th√™m/c·∫≠p nh·∫≠t s·∫£n ph·∫©m:', err);
                showGlobalFeedback(err.message || 'C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.', false);
            }
        });

        // Edit Product (populate form)
        window.editProduct = async (productId) => {
            try {
                const res = await fetch(`${API_URL}/${productId}`);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const product = await res.json();

                productIdInput.value = product.id;
                productNameInput.value = product.name;
                productPriceInput.value = product.price;
                productDescriptionInput.value = product.description;
                productImageInput.value = product.image;

                formTitle.textContent = 'S·ª≠a th√¥ng tin s·∫£n ph·∫©m';
                submitProductBtn.textContent = 'C·∫≠p nh·∫≠t s·∫£n ph·∫©m';
                submitProductBtn.classList.replace('btn-add', 'btn-update'); // Change button style
                cancelEditBtn.style.display = 'inline-block'; // Show cancel button

                showProductFormModal(); // Hi·ªÉn th·ªã form ƒë·ªÉ ch·ªânh s·ª≠a

            } catch (err) {
                console.error('L·ªói khi t·∫£i th√¥ng tin s·∫£n ph·∫©m ƒë·ªÉ s·ª≠a:', err);
                showGlobalFeedback('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin s·∫£n ph·∫©m ƒë·ªÉ s·ª≠a.', false);
            }
        };

        // Delete Product
        async function deleteProduct(productId) {
            hideConfirmationModal(); // Hide modal immediately after confirmation

            try {
                const res = await fetch(`${API_URL}/${productId}`, {
                    method: 'DELETE',
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m.');
                }

                showGlobalFeedback(`S·∫£n ph·∫©m v·ªõi ID ${productId} ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng.`, true);
                loadProducts(); // Reload the table to reflect the changes
            } catch (err) {
                console.error('L·ªói khi x√≥a s·∫£n ph·∫©m:', err);
                showGlobalFeedback(err.message || 'Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m.', false);
            }
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', loadProducts);
    </script>
</body>

</html>